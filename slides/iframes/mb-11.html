<script type="text/javascript" charset="utf-8">

var particles = [
  new Physics.Particle(-1, -.5, 0, 1, .5, 0, .09, 1),
];

var npart = particles.length;

var constraints = [
  new Physics.BoxCollider(4, 4, 4, 1),
  new Physics.ParticleCollider(1),
  new Physics.Gravity(1),
];

var physics = window.physics = new Physics.Engine({
  method: 'euler',
  step: 1/60,
}, particles, constraints);

var activePhysics = [8];

window.requestAnimationFrame(function loop() {
  window.requestAnimationFrame(loop);

  if (window.director && (activePhysics.indexOf(window.director[0].step) != -1)) {
    physics.update();
  }
});

var positionCache = {};
var velocityCache = {};
var accelerationCache = {};

function snapshotPosition(sample, i) {
  var cache = positionCache[sample];
  if (cache == null) {
    cache = positionCache[sample] = {};
  }
  return (cache[i] = cache[i] || physics.position(i));
}

function snapshotVelocity(sample, i, end, scale) {
  var cache = velocityCache[sample];
  if (cache == null) {
    cache = velocityCache[sample] = {};
  }
  var key = i +','+ end +','+ scale;
  return (cache[key] = cache[key] || physics.velocity(i, end, scale));
}

function snapshotAcceleration(sample, i, end, scale) {
  var cache = accelerationCache[sample];
  if (cache == null) {
    cache = accelerationCache[sample] = {};
  }
  var key = i +','+ end +','+ scale;
  return (cache[key] = cache[key] || physics.acceleration(i, end, scale));
}

function bigparticle(index) {
  return function (x, i) {
    var p = physics.point(index);
    var r = physics.particles[index].radius;
    return [p[0] + Math.cos(x) * r, p[1] + Math.sin(x) * r];
  }
}

window.mathBoxSetup = function (mathbox, director) {

  mathbox
    .viewport({
      type: 'cartesian',
      range: [[-2, 2], [-2, 2]],
      scale: [1, 1],
    })
    .grid({
      ticks: [2, 2],
      zIndex: -9,
    })
    .curve({
      n: 5,
      points: false,
      line: true,
      live: true,
      expression: function (x, i) {
        return [Math.cos(x*τ+τ/8)/0.707*2, Math.sin(x*τ+τ/8)/0.707*2, 0];
      },
      color: 0x000000,
      opacity: 0.5,
      zIndex: -10,
    });

  director.on('go', function (step, direction) {
    var laststep = physics.options.step,
        timestep = null;

    if (step == 1 && direction > 0) {
      timestep = 0;
    }

    if (step == 4 && direction > 0) {
      timestep = 1;
    }
    else if (step == 3 && direction < 0) {
      timestep = -1;
    }

    if (step == 7 && direction > 0) {
      timestep = .5;
    }
    else if (step == 6 && direction < 0) {
      timestep = -.5;
    }

    if (timestep !== null) {
      physics.options.step = timestep;
      physics.update();
      physics.options.step = laststep;
    }
  });
}

window.mathBoxScript = [

  [
    ['add', 'curve', {
      id: "point",
      n: npart,
      points: true,
      line: false,
      live: true,
      expression: function (x, i) {
        return snapshotPosition(1, i);
      },
      color: 0x000000,
      pointSize: 20,
      zIndex: 20,
    }],
    ['add', 'vector', {
      id: "pos",
      n: 2,
      live: true,
      expression: function (i, end) {
        return end ? snapshotPosition(1, i) : [-2, -2, 0];
      },
      lineWidth: 6,
      size: .1,
    }],
    ['add', 'vector', {
      id: "vel",
      n: 2,
      live: true,
      expression: function (i, end) {
        return snapshotVelocity(1, i, end, 1);
      },
      color: 0x20C050,
      lineWidth: 6,
      size: .1,
      zIndex: 10,
    }],
  ],

  [
    ['add', 'vector', {
      id: "accel",
      n: 1,
      expression: function (i, end) {
        var p = snapshotPosition(1, i).slice();
        var a = physics.particles[i].acceleration;
        console.log('a', a.x, a.y)
        if (end) {
          p[0] += a.x;
          p[1] += a.y;
          p[2] += a.z;
        }
        return p;
      },
      color: 0xC02050,
      lineWidth: 6,
      size: .1,
    }, {
      duration: 300,
    }],
  ],

];


</script>
